<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Table Relationship Editor</title>
  <script type="module" src="./main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #canvas {
      flex: 3;
      position: relative;
      background: #f5f5f5;
      border-right: 1px solid #ddd;
      overflow: auto;
    }

    #sidebar {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 13px;
    }

    .table-node {
      position: absolute;
      min-width: 180px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #ccc;
      padding: 4px 0 4px 0;
      cursor: move;
    }

    .table-title {
      font-weight: 600;
      font-size: 14px;
      padding: 4px 8px;
      border-bottom: 1px solid #ddd;
      background: #f0f0f0;
      border-radius: 8px 8px 0 0;
    }

    .columns {
      padding: 4px 0;
      max-height: 240px;
      overflow-y: auto;
    }

    .column {
      padding: 2px 8px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .column span.name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .column span.dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #555;
      margin-left: 6px;
    }

    h2 {
      margin-top: 0;
      font-size: 16px;
    }

    pre {
      background: #272822;
      color: #f8f8f2;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      overflow-x: auto;
    }
  </style>
</head>
<body data-page="datahub">

<div id="canvas"></div>

<div id="sidebar">
  <h2>Relationships</h2>
  <div id="relationships-list"></div>
  <h3>JSON</h3>
  <pre id="relationships-json"></pre>
</div>

<script>
  // Example schema (we’ll replace this from Python later)
  const schema = {
    "Customers": ["CustomerID", "Name", "Country"],
    "Orders": ["OrderID", "CustomerID", "OrderDate", "Total"],
    "OrderLines": ["OrderLineID", "OrderID", "ProductID", "Qty"],
    "Products": ["ProductID", "Name", "Price"]
  };

  // Store relationships as we create connections
  const relationships = [];

  function renderRelationships() {
    const listDiv = document.getElementById("relationships-list");
    const jsonPre = document.getElementById("relationships-json");

    listDiv.innerHTML = "";
    relationships.forEach((rel, i) => {
      const p = document.createElement("div");
      p.textContent =
        `${i+1}. ${rel.fromTable}.${rel.fromColumn}  →  ` +
        `${rel.toTable}.${rel.toColumn}  (type: ${rel.joinType})`;
      listDiv.appendChild(p);
    });

    jsonPre.textContent = JSON.stringify(relationships, null, 2);
  }

  jsPlumb.ready(function () {
    const instance = jsPlumb.getInstance({
      Container: "canvas",
      Connector: ["Flowchart", { cornerRadius: 5 }],
      Endpoint: ["Dot", { radius: 4 }],
      PaintStyle: { strokeWidth: 2 },
      EndpointStyle: { fill: "#ffffff" }
    });

    const canvas = document.getElementById("canvas");

    // Simple layout: place tables in a grid
    const tableNames = Object.keys(schema);
    const cols = 2;
    const xGap = 260;
    const yGap = 220;
    tableNames.forEach((tableName, idx) => {
      const tableDiv = document.createElement("div");
      tableDiv.className = "table-node";
      tableDiv.id = "table_" + tableName;
      tableDiv.style.left = (20 + (idx % cols) * xGap) + "px";
      tableDiv.style.top = (20 + Math.floor(idx / cols) * yGap) + "px";

      const titleDiv = document.createElement("div");
      titleDiv.className = "table-title";
      titleDiv.textContent = tableName;
      tableDiv.appendChild(titleDiv);

      const colsDiv = document.createElement("div");
      colsDiv.className = "columns";
      tableDiv.appendChild(colsDiv);

      schema[tableName].forEach(colName => {
        const colDiv = document.createElement("div");
        colDiv.className = "column";
        colDiv.dataset.table = tableName;
        colDiv.dataset.column = colName;

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = colName;
        colDiv.appendChild(nameSpan);

        const dotSpan = document.createElement("span");
        dotSpan.className = "dot";
        colDiv.appendChild(dotSpan);

        colsDiv.appendChild(colDiv);

        // Make each column an endpoint (source + target)
        instance.addEndpoint(colDiv, {
          anchor: "Right",
          isSource: true,
          isTarget: true,
          maxConnections: -1,
          connector: ["Flowchart"],
          parameters: {
            table: tableName,
            column: colName
          }
        });
      });

      canvas.appendChild(tableDiv);
      instance.draggable(tableDiv);
    });

    // On new connection, add to relationships model
    instance.bind("connection", function (info) {
      const sourceCol = info.source;
      const targetCol = info.target;

      const fromTable = sourceCol.dataset.table;
      const fromColumn = sourceCol.dataset.column;
      const toTable = targetCol.dataset.table;
      const toColumn = targetCol.dataset.column;

      // For now, assume INNER join; you could expose a dropdown to change this
      const joinType = "inner";

      relationships.push({
        fromTable,
        fromColumn,
        toTable,
        toColumn,
        joinType
      });

      renderRelationships();
    });

    // If you remove a connection, remove from relationships array
    instance.bind("connectionDetached", function (info) {
      const sourceCol = info.source;
      const targetCol = info.target;
      const fromTable = sourceCol.dataset.table;
      const fromColumn = sourceCol.dataset.column;
      const toTable = targetCol.dataset.table;
      const toColumn = targetCol.dataset.column;

      const idx = relationships.findIndex(r =>
        r.fromTable === fromTable &&
        r.fromColumn === fromColumn &&
        r.toTable === toTable &&
        r.toColumn === toColumn
      );
      if (idx !== -1) {
        relationships.splice(idx, 1);
        renderRelationships();
      }
    });

    renderRelationships();
  });
</script>

</body>
</html>
