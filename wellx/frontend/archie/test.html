<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plotly Log View — Trails Registry (Auto-Expand Range)</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
      --btn:#1f2937;
      --btn2:#0b1220;
      --accent:#60a5fa;
      --danger:#f87171;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
    }
    .app{
      display:grid;
      grid-template-columns: 380px 1fr;
      height:100vh;
      gap:0;
    }
    .sidebar{
      border-right:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      padding:14px;
      overflow:auto;
    }
    .main{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(17,24,39,0.9);
      backdrop-filter: blur(8px);
    }
    header .title{
      font-weight:700;
      letter-spacing:.2px;
    }
    header .sub{
      font-size:12px;
      color:var(--muted);
    }
    #plot{
      width:100%;
      height:100%;
      min-height:0;
      flex:1;
    }

    h2{
      margin:14px 0 10px;
      font-size:14px;
      color:var(--text);
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(15,23,42,0.55);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:10px 0;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin:10px 0;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    select, input[type="number"], input[type="text"]{
      width:100%;
      box-sizing:border-box;
      padding:10px 10px;
      background:#0b1220;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      outline:none;
    }
    select:focus, input:focus{
      border-color: rgba(96,165,250,0.7);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.12);
    }
    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.1px;
      transition: transform .02s ease, border-color .15s ease, background .15s ease;
    }
    button:hover{ border-color: rgba(96,165,250,0.55); }
    button:active{ transform: translateY(1px); }
    button.secondary{ background: var(--btn2); }
    button.danger{ border-color: rgba(248,113,113,0.45); }
    button.danger:hover{ border-color: rgba(248,113,113,0.75); }
    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .hr{
      height:1px;
      background:var(--line);
      margin:12px 0;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:rgba(11,18,32,0.65);
    }
    .pill .meta{
      flex:1;
      min-width:0;
    }
    .pill .name{
      font-weight:700;
      font-size:13px;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill .small{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill .actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .pill .actions button{
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
    }
    .chip{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(31,41,55,0.5);
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="card">
        <div style="display:flex; gap:10px; align-items:baseline; justify-content:space-between;">
          <div>
            <div style="font-weight:800; font-size:15px;">Trails Registry Demo</div>
            <div class="note">Single Plotly figure with <span class="chip">N trails (x-axes)</span> + shared depth axis.</div>
          </div>
          <div class="chip">scattergl</div>
        </div>

        <div class="hr"></div>

        <h2>Layout</h2>
        <div class="row">
          <div>
            <label for="trailCount">Number of trails</label>
            <input id="trailCount" type="number" min="1" max="8" value="3"/>
          </div>
          <div>
            <label for="gap">Gap (domain)</label>
            <input id="gap" type="number" min="0" max="0.05" step="0.005" value="0.01"/>
          </div>
        </div>
        <div class="btnbar">
          <button id="applyLayout">Apply layout</button>
          <button class="secondary" id="resetZoom">Reset depth zoom</button>
        </div>

        <div class="hr"></div>

        <h2>Add curve</h2>
        <div class="row">
          <div>
            <label for="curveType">Curve template</label>
            <select id="curveType">
              <option value="GR">GR-like (0–150)</option>
              <option value="RT">Resistivity-like (0.2–200)</option>
              <option value="NPHI">NPHI-like (0–0.45)</option>
              <option value="RHOB">RHOB-like (1.9–2.7)</option>
              <option value="CUSTOM">Custom (random)</option>
            </select>
          </div>
          <div>
            <label for="targetTrail">Target trail</label>
            <select id="targetTrail"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="curveName">Curve name</label>
            <input id="curveName" type="text" value="GR"/>
          </div>
          <div>
            <label for="points">Points</label>
            <input id="points" type="number" min="2000" max="200000" step="1000" value="60000"/>
          </div>
        </div>

        <div class="btnbar">
          <button id="addCurve">Add curve</button>
          <button class="secondary" id="addTwoForFill">Add 2 curves (for fill)</button>
        </div>

        <div class="hr"></div>

        <h2>Fill between curves</h2>
        <div class="row">
          <div>
            <label for="fillA">Curve A</label>
            <select id="fillA"></select>
          </div>
          <div>
            <label for="fillB">Curve B</label>
            <select id="fillB"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="fillTrail">Trail</label>
            <select id="fillTrail"></select>
          </div>
          <div>
            <label for="fillMode">Fill mode</label>
            <select id="fillMode">
              <option value="tonextx">tonextx (fill between x traces)</option>
              <option value="tozerox">tozerox (to x=0 baseline)</option>
            </select>
          </div>
        </div>
        <div class="btnbar">
          <button id="makeFill">Create fill</button>
          <button class="danger" id="clearFill">Remove fills</button>
        </div>

        <div class="hr"></div>

        <h2>Curves</h2>
        <div class="note">
          - Move curves between trails (they adopt the trail’s x-range).<br/>
          - Trails auto-expand x-range to include new curves.
        </div>
        <div class="list" id="curveList"></div>
      </div>
    </aside>

    <div class="main">
      <header>
        <div>
          <div class="title">Plotly Log View (Depth)</div>
          <div class="sub">Unified depth zoom • N trails • auto-expand trail ranges • move curves • fill between curves</div>
        </div>
        <div class="chip" id="status">Ready</div>
      </header>
      <div id="plot"></div>
    </div>
  </div>

<script>
/** =========================
 *  Utilities
 *  ========================= */

const $ = (sel, host=document) => host.querySelector(sel);

function axisIdForTrail(trailIndex) {
  return trailIndex === 1 ? "x" : `x${trailIndex}`;
}
function getTrailAxisName(trailIndex) {
  return trailIndex === 1 ? "xaxis" : `xaxis${trailIndex}`;
}

function computeRangeFromX(x) {
  let min = Infinity, max = -Infinity;
  for (let i = 0; i < x.length; i++) {
    const v = x[i];
    if (v == null || !Number.isFinite(v)) continue;
    if (v < min) min = v;
    if (v > max) max = v;
  }
  if (min === Infinity || max === -Infinity) return null;
  if (min === max) return [min - 1, max + 1];
  return [min, max];
}

function mergeRanges(a, b) {
  if (!a) return b;
  if (!b) return a;
  return [Math.min(a[0], b[0]), Math.max(a[1], b[1])];
}

function getTrailRange(layout, trailIndex) {
  const ax = layout?.[getTrailAxisName(trailIndex)];
  return Array.isArray(ax?.range) ? ax.range : null;
}

function setStatus(msg) {
  $("#status").textContent = msg;
  setTimeout(() => { $("#status").textContent = "Ready"; }, 1000);
}

/** =========================
 *  Layout builder
 *  ========================= */
function buildLogLayout({ trails = 3, gap = 0.01 } = {}) {
  const layout = {
    dragmode: "pan",
    hovermode: "closest",
    uirevision: "logview",
    margin: { l: 70, r: 120, t: 70, b: 40 },

    yaxis: {
      title: "Depth (m)",
      autorange: "reversed",
      showgrid: true,
      zeroline: false,
    },

    // label axis (simple ticks); you can switch to annotations if you prefer
    yaxis2: {
      overlaying: "y",
      side: "right",
      showgrid: false,
      zeroline: false,
      tickmode: "array",
      tickvals: [1000, 2000, 3000, 4000],
      ticktext: ["Top A", "Top B", "Top C", "Top D"],
      ticklen: 0,
    },

    legend: {
      orientation: "h",
      x: 0,
      y: 1.18,
      groupclick: "toggleitem",
    },
  };

  const totalGap = gap * (trails - 1);
  const w = (1 - totalGap) / trails;

  for (let i = 1; i <= trails; i++) {
    const axName = getTrailAxisName(i);
    const start = (i - 1) * (w + gap);
    const end = start + w;

    layout[axName] = {
      domain: [start, end],
      anchor: "y",
      showgrid: false,
      zeroline: false,
      mirror: true,
      ticks: "inside",
      title: `Trail ${i}`,
      // range is "owned" by the trail; it will be set/expanded automatically
    };
  }

  return layout;
}

/** =========================
 *  Synthetic log data (demo)
 *  ========================= */
function makeDepth(points, zTop=0, zBase=5000) {
  // points ~ 60k gives nice performance with scattergl
  const dz = (zBase - zTop) / (points - 1);
  const depth = new Array(points);
  for (let i = 0; i < points; i++) depth[i] = zTop + i * dz;
  return depth;
}

function randn(seedObj) { // deterministic-ish, small
  seedObj.v = (seedObj.v * 1664525 + 1013904223) >>> 0;
  const u = (seedObj.v & 0xffff) / 0x10000;
  seedObj.v = (seedObj.v * 1664525 + 1013904223) >>> 0;
  const v = (seedObj.v & 0xffff) / 0x10000;
  return Math.sqrt(-2 * Math.log(u + 1e-9)) * Math.cos(2 * Math.PI * v);
}

function makeCurve(template, depth, seed=123) {
  const n = depth.length;
  const x = new Array(n);
  const s = { v: seed >>> 0 };

  // Some wavy + noisy shapes
  for (let i = 0; i < n; i++) {
    const z = depth[i];

    if (template === "GR") {
      // 0..150
      const base = 70 + 30 * Math.sin(z / 120) + 15 * Math.sin(z / 35);
      const noise = 6 * randn(s);
      x[i] = Math.max(0, Math.min(150, base + noise));
    } else if (template === "RT") {
      // log-like resistivity 0.2..200
      const logv = 0.3 + 0.5 * Math.sin(z / 200) + 0.3 * Math.sin(z / 50) + 0.15 * randn(s);
      const v = Math.pow(10, logv); // ~ 0.5..50 with spikes
      x[i] = Math.max(0.2, Math.min(200, v));
    } else if (template === "NPHI") {
      // 0..0.45
      const base = 0.25 + 0.06 * Math.sin(z / 150) - 0.04 * Math.sin(z / 40);
      const noise = 0.015 * randn(s);
      x[i] = Math.max(0, Math.min(0.45, base + noise));
    } else if (template === "RHOB") {
      // 1.9..2.7
      const base = 2.35 + 0.10 * Math.sin(z / 180) + 0.06 * Math.sin(z / 55);
      const noise = 0.02 * randn(s);
      x[i] = Math.max(1.9, Math.min(2.7, base + noise));
    } else {
      // CUSTOM random-ish
      const base = 10 + 2 * Math.sin(z / 90) + 1.5 * Math.sin(z / 27);
      const noise = 1.0 * randn(s);
      x[i] = base + noise;
    }
  }

  return x;
}

/** =========================
 *  Trail range policy: auto-expand
 *  ========================= */
async function ensureTrailRangeInitializedOrExpanded(gd, trailIndex, x) {
  const axName = getTrailAxisName(trailIndex);
  const existing = getTrailRange(gd.layout, trailIndex);
  const incoming = computeRangeFromX(x);

  if (!incoming) return;

  const merged = mergeRanges(existing, incoming);

  // Only relayout if needed (avoid extra work)
  const needs =
    !existing ||
    merged[0] !== existing[0] ||
    merged[1] !== existing[1];

  if (needs) {
    await Plotly.relayout(gd, { [`${axName}.range`]: merged });
  }
}

/** =========================
 *  Add/move curves
 *  ========================= */
let curveCounter = 0;

function makeLogTrace({ name, x, depth, trailIndex }) {
  return {
    name,
    type: "scattergl",
    mode: "lines",
    x,
    y: depth,
    xaxis: axisIdForTrail(trailIndex),
    yaxis: "y",
    legendgroup: `trail${trailIndex}`,
    legendgrouptitle: { text: `Trail ${trailIndex}` },
    // helpful: do not show markers; keep hover light
    hovertemplate: `${name}<br>x=%{x}<br>Depth=%{y:.2f}<extra></extra>`,
  };
}

async function addCurve(gd, { template, name, trailIndex, points }) {
  const depth = window.__depth || (window.__depth = makeDepth(points, 0, 5000));
  // If points differ, rebuild depth for that curve (demo)
  const d = (depth.length === points) ? depth : makeDepth(points, 0, 5000);

  const seed = 1000 + curveCounter * 97;
  const x = makeCurve(template, d, seed);

  await ensureTrailRangeInitializedOrExpanded(gd, trailIndex, x);

  const trace = makeLogTrace({
    name,
    x,
    depth: d,
    trailIndex,
  });

  await Plotly.addTraces(gd, trace);
  curveCounter++;

  setStatus(`Added ${name} to Trail ${trailIndex}`);
  refreshUI(gd);
}

async function moveCurveToTrail(gd, traceIndex, targetTrailIndex) {
  const trace = gd.data[traceIndex];
  if (!trace) return;

  // auto-expand target trail to include this curve’s x-range
  await ensureTrailRangeInitializedOrExpanded(gd, targetTrailIndex, trace.x || []);

  await Plotly.restyle(
    gd,
    {
      xaxis: axisIdForTrail(targetTrailIndex),
      yaxis: "y",
      legendgroup: `trail${targetTrailIndex}`,
      legendgrouptitle: { text: `Trail ${targetTrailIndex}` },
    },
    [traceIndex]
  );

  setStatus(`Moved "${trace.name}" → Trail ${targetTrailIndex}`);
  refreshUI(gd);
}

/** =========================
 *  Fill between curves
 *  ========================= */
function isFillTrace(t) {
  return t?.meta?.isFill === true;
}

async function addFillBetween(gd, idxA, idxB, trailIndex, fillMode="tonextx") {
  const A = gd.data[idxA];
  const B = gd.data[idxB];
  if (!A || !B) return;

  // Ensure both are on the same trail (you chose the target trail)
  // We will add A as a hidden base copy (optional), then fill trace for B.
  // For a demo, we keep originals and create a dedicated fill pair.

  // Auto-expand trail for both ranges
  await ensureTrailRangeInitializedOrExpanded(gd, trailIndex, A.x || []);
  await ensureTrailRangeInitializedOrExpanded(gd, trailIndex, B.x || []);

  const base = {
    type: "scattergl",
    mode: "lines",
    x: A.x,
    y: A.y,
    xaxis: axisIdForTrail(trailIndex),
    yaxis: "y",
    name: `${A.name} (fill base)`,
    showlegend: false,
    hoverinfo: "skip",
    line: { width: 0 }, // invisible line
    meta: { isFill: true },
  };

  const fill = {
    type: "scattergl",
    mode: "lines",
    x: B.x,
    y: B.y,
    xaxis: axisIdForTrail(trailIndex),
    yaxis: "y",
    name: `Fill: ${A.name} ↔ ${B.name}`,
    showlegend: true,
    legendgroup: `trail${trailIndex}`,
    legendgrouptitle: { text: `Trail ${trailIndex}` },
    hoverinfo: "skip",
    fill: fillMode,   // tonextx fills to previous trace
    meta: { isFill: true },
  };

  await Plotly.addTraces(gd, [base, fill]);
  setStatus(`Fill created on Trail ${trailIndex}`);
  refreshUI(gd);
}

async function removeAllFills(gd) {
  const idx = [];
  for (let i = 0; i < gd.data.length; i++) {
    if (isFillTrace(gd.data[i])) idx.push(i);
  }
  if (!idx.length) return;
  // delete from end
  idx.sort((a,b)=>b-a);
  for (const i of idx) await Plotly.deleteTraces(gd, i);
  setStatus("Removed fill traces");
  refreshUI(gd);
}

/** =========================
 *  UI wiring
 *  ========================= */
function fillTrailSelects(trails) {
  const opts = Array.from({length: trails}, (_,i)=> {
    const k = i+1;
    return `<option value="${k}">Trail ${k}</option>`;
  }).join("");

  $("#targetTrail").innerHTML = opts;
  $("#fillTrail").innerHTML = opts;
}

function refreshCurveSelects(gd) {
  // Only list non-fill traces for fill selections
  const curves = gd.data
    .map((t, i) => ({ i, t }))
    .filter(({t}) => !isFillTrace(t));

  const options = curves.map(({i, t}) => {
    const trail = (t.xaxis || "x");
    return `<option value="${i}">#${i} • ${t.name} • ${trail}</option>`;
  }).join("");

  $("#fillA").innerHTML = options;
  $("#fillB").innerHTML = options;
}

function makeCurveListItem(gd, i, t, trails) {
  const trail = t.xaxis || "x";
  const trailIndex = trail === "x" ? 1 : Number(trail.slice(1));
  const range = getTrailRange(gd.layout, trailIndex);

  const moveButtons = Array.from({length: trails}, (_,k)=>k+1)
    .map(k => `<button class="secondary" data-move="${k}" title="Move to Trail ${k}">→ ${k}</button>`)
    .join("");

  return `
    <div class="pill" data-trace-index="${i}">
      <div class="meta">
        <div class="name">#${i} • ${t.name}</div>
        <div class="small">Trail: ${trail} ${range ? ` • trail range: [${range[0].toFixed(3)}, ${range[1].toFixed(3)}]` : " • trail range: (unset)"}</div>
      </div>
      <div class="actions">
        ${moveButtons}
        <button class="danger" data-del="1">Delete</button>
      </div>
    </div>
  `;
}

function refreshCurveList(gd, trails) {
  const host = $("#curveList");
  const rows = [];
  for (let i = 0; i < gd.data.length; i++) {
    const t = gd.data[i];
    if (isFillTrace(t)) continue; // keep list cleaner
    rows.push(makeCurveListItem(gd, i, t, trails));
  }
  host.innerHTML = rows.join("") || `<div class="note">No curves yet. Add one above.</div>`;

  // delegate clicks
  host.onclick = async (e) => {
    const pill = e.target.closest(".pill");
    if (!pill) return;
    const idx = Number(pill.getAttribute("data-trace-index"));
    const gd = window.__gd;

    const move = e.target.getAttribute("data-move");
    if (move) {
      await moveCurveToTrail(gd, idx, Number(move));
      return;
    }
    const del = e.target.getAttribute("data-del");
    if (del) {
      await Plotly.deleteTraces(gd, idx);
      setStatus(`Deleted curve #${idx}`);
      refreshUI(gd);
      return;
    }
  };
}

function refreshUI(gd) {
  const trails = Number($("#trailCount").value) || 3;
  refreshCurveSelects(gd);
  refreshCurveList(gd, trails);
}

function syncNameWithTemplate() {
  const tpl = $("#curveType").value;
  const n = $("#curveName");
  if (tpl !== "CUSTOM") n.value = tpl;
}

$("#curveType").addEventListener("change", syncNameWithTemplate);

/** =========================
 *  Boot
 *  ========================= */
async function init() {
  const trails = Number($("#trailCount").value) || 3;
  const gap = Number($("#gap").value) || 0.01;

  fillTrailSelects(trails);

  const gd = $("#plot");
  window.__gd = gd;

  const layout = buildLogLayout({ trails, gap });
  const config = { responsive: true, scrollZoom: true, displaylogo: false };

  await Plotly.newPlot(gd, [], layout, config);

  // default depth window (feel free to change)
  await Plotly.relayout(gd, { "yaxis.range": [3500, 1000] });

  // wire buttons
  $("#applyLayout").onclick = async () => {
    const trails = Number($("#trailCount").value) || 3;
    const gap = Number($("#gap").value) || 0.01;

    // keep existing traces; rebuild layout domains/axes
    const newLayout = buildLogLayout({ trails, gap });

    // Preserve current depth window if exists:
    const yRange = gd.layout?.yaxis?.range;
    if (Array.isArray(yRange)) newLayout.yaxis.range = yRange;

    await Plotly.relayout(gd, newLayout);

    fillTrailSelects(trails);
    refreshUI(gd);
    setStatus("Layout applied");
  };

  $("#resetZoom").onclick = async () => {
    await Plotly.relayout(gd, { "yaxis.autorange": "reversed" });
    setStatus("Depth zoom reset");
  };

  $("#addCurve").onclick = async () => {
    const template = $("#curveType").value;
    const name = $("#curveName").value.trim() || `Curve ${curveCounter+1}`;
    const trailIndex = Number($("#targetTrail").value) || 1;
    const points = Number($("#points").value) || 60000;

    await addCurve(gd, { template, name, trailIndex, points });
  };

  $("#addTwoForFill").onclick = async () => {
    const trailIndex = Number($("#targetTrail").value) || 1;
    const points = Number($("#points").value) || 60000;

    await addCurve(gd, { template: "GR", name: `GR_${curveCounter+1}`, trailIndex, points });
    await addCurve(gd, { template: "NPHI", name: `NPHI_${curveCounter+1}`, trailIndex, points });
  };

  $("#makeFill").onclick = async () => {
    const idxA = Number($("#fillA").value);
    const idxB = Number($("#fillB").value);
    const trailIndex = Number($("#fillTrail").value) || 1;
    const fillMode = $("#fillMode").value;

    if (idxA === idxB) { setStatus("Pick two different curves"); return; }
    await addFillBetween(gd, idxA, idxB, trailIndex, fillMode);
  };

  $("#clearFill").onclick = async () => {
    await removeAllFills(gd);
  };

  // start with a couple of curves
  await addCurve(gd, { template: "GR", name: "GR", trailIndex: 1, points: 60000 });
  await addCurve(gd, { template: "RT", name: "RT", trailIndex: 2, points: 60000 });
  await addCurve(gd, { template: "RHOB", name: "RHOB", trailIndex: 3, points: 60000 });

  refreshUI(gd);
}

init();
</script>
</body>
</html>
